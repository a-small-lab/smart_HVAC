---
title: "Data Cleaning and (preliminary) EDA"
author: "Caleb Neale"
date: "Spring 2021"
output:
  pdf_document: default
  html_notebook: default
subtitle: Optimizing HVAC Operation for Occupant Comfort and Energy Savings
---

# Load libraries 
```{r}
library(tidyverse)
library(lubridate)
library(fpp3)
```

# Import Data and convert to tibble
```{r warning=FALSE}
read_and_clean <- function(csv_path){
  df <- read.csv(csv_path, sep=";", row.names = NULL)
  colnames(df) <- c("series", 'time','value')
  
  # NAs will be induced by following line, seems like this occurs when the value in the 'value' column == null
  df$value <- as.numeric(df$value)
  df<- df[-1,]
  df <- as_tibble(df)
  return(df)
}

co2 <- read_and_clean('co2.csv')
occupied_status <- read_and_clean('occupied_status.csv')
occupied_status$value <- as.factor(occupied_status$value)
supply_air_flow <- read_and_clean('supply_air_flow.csv')
supply_fan <- read_and_clean('supply_fan.csv')
supply_fan$value <- as.factor(supply_fan$value)
temperature <- read_and_clean('temperature.csv')

```
# Check for NaN
```{r}
sum(is.na(occupied_status$value))
sum(is.na(co2$value))
sum(is.na(supply_air_flow$value)) # lot of NAs (over 32000)
sum(is.na(supply_fan$value))
sum(is.na(temperature$value)) # lot of NAs (over 15000)

```

# Convert time data to datetime format
```{r}

convert_to_datetime <- function(df){
  df$time <- gsub("-04:00$", "-0400", df$time)
  df$time <- gsub("-05:00$", "-0500", df$time)
  df$time <- strptime(df$time, format ="%Y-%m-%dT%H:%M:%S%z")
  df$time <- as.POSIXct(df$time)
  return(df)
}

co2 <- convert_to_datetime(co2)
occupied_status <- convert_to_datetime(occupied_status)
supply_air_flow <- convert_to_datetime(supply_air_flow)
supply_fan <- convert_to_datetime(supply_fan)
temperature <- convert_to_datetime(temperature)

```


# Investigate data in series columns
```{r}
co2 %>% count(series) 

supply_air_flow %>% count(value)

supply_fan %>% count(series)

temperature %>% count(series)

occupied_status %>% count(series)

```
Co2 data is only provided for 6 rooms: Olsson 203, 211, 213, 217, 221, 225. Investigating whether additional rooms are available. 

Supply_air_flow contains data for 45 rooms in Olsson hall, as well as set-point data for each room. (Note: Investigate documentation for definition of set-point data)

Supply_fan_status is given for both HVAC units; the nature of the time intervals of the supply generating process is still under investigation. 

Temperature is given for 44 rooms in Olsson, all but the generic "2nd floor" label which was fond in the supply_air_flow table. There is no set-point data provided here. 

Occupied_status is given for both HVAC units. As the status is not given by room, I'm looking for documentation which shows what occupied_status means in the system. The nature of the time intervals of the supply generating process is still under investigation. 


# Create rooms column by parsing from series column 
```{r}
co2$room = regmatches(x= co2$series, m=regexpr("([0-9]{3})", co2$series))

supply_air_flow$room = str_match(supply_air_flow$series, "C[0-9]{3}|[0-9]{3}")

temperature$room = str_match(temperature$series, "C[0-9]{3}|[0-9]{3}")

```

There exists a mapping from HVAC unit to rooms which could be used to relate observations on the room level and observations on the system level (e.g. which rooms are receiving supply at a given time based on supply_status data)

# Create room assignment vectors for each HVAC unit

```{r}
AHU_2E <- c(241, 243, 245, 247, 249, 251, 253, 257, 255, 259, 263, 261, 240, "C244", 244, 260, 213, 217, 225, 218, "C230", 220, "C210", "T212", "T218", "C216", "C214", "T210", 256, 229, 231, 223, 225, "C227", "C211", 254, "C250", 258) 

AHU_2W <- c(269, 267, 265, 273, 271, 275, 277, 279, 281, 283, 285, 274, 286, 204, 208, 272, 270, "C260", "C200", "C201", 203, 276, "C280", "C270", 211, 201)

# Check for duplicates/overlap

table(AHU_2E)

table(AHU_2W)

table(c(AHU_2E, AHU_2W))

```

# Parse equipment names from series column
```{r}
occupied_status$equiment <- str_match(occupied_status$series, "AHU2[EW]")
supply_fan$equipment <- str_match(supply_fan$series, "AHU2[EW]")
```


# Final Table Designs

## Table for analysis of system dynamics and energy consumption

Key: HVAC unit
Index: time (3 hour intervals? pending documentation)
Observations: supply air flow (aggregated by HVAC unit), supply air flow set-point (aggregated by HVAC unit), supply fan, energy use (calculated)

Data cleaning tasks:
- Unstack supply_air_flow data such that there is a column for value and a column for set-point for each room at each time-stamp
- Aggregate flow and set-point values for each HVAC unit to create an HVAC unit value at each time-stamp
- For every three hour interval, assign the supply fan status column to the most recent value from supply_fan for each AHU
- Calculate energy consumption and input into final column 

### Unstack supply_air_flow

```{r}
supply_air_flow %>% filter(grepl("Setpoint", series)) -> supply_air_flow_setpoints

supply_air_flow %>% filter(!grepl("Setpoint", series)) -> supply_air_flow


inner_join(supply_air_flow_setpoints,supply_air_flow, by=c("room", "time")) %>% select(c("time", "value.x", "value.y", "room")) -> unstacked_supply_air

colnames(unstacked_supply_air) <- c("time", "setpoint", "value", "room")

```

### Aggregate flow and set point by HVAC unit
```{r}
unstacked_supply_air <- as_tsibble(unstacked_supply_air, key= room, index = time)
library(dplyr)

unstacked_supply_air %>% filter(room %in% AHU_2E) -> air_supply_AHU_2E
unstacked_supply_air %>% filter(room %in% AHU_2W) -> air_supply_AHU_2W

aggregated_AHU_2E <- aggregate(cbind(air_supply_AHU_2E$setpoint, air_supply_AHU_2E$value), by=list(time=air_supply_AHU_2E$time), FUN=sum)

aggregated_AHU_2W <- aggregate(cbind(air_supply_AHU_2W$setpoint, air_supply_AHU_2W$value), by=list(time=air_supply_AHU_2W$time), FUN=sum)

colnames(aggregated_AHU_2E) = c("time", "setpoint", "air_supply")
colnames(aggregated_AHU_2W) = c("time", "setpoint", "air_supply")

inner_join(aggregated_AHU_2E, aggregated_AHU_2W, by=c("time"), suffix=c(".AHU2E", ".AHU2W")) -> unit_supply_air

```

### Feed forward supply_fan data
```{r, eval=FALSE}
# create df where columns are time, AHU2E status, AHU2W status
supply_fan %>% filter(equipment == "AHU2E") -> AHU2E_supply_fan
supply_fan %>% filter(equipment == "AHU2W") -> AHU2W_supply_fan

unstacked_fan = full_join(AHU2E_supply_fan, AHU2W_supply_fan, by=c("time"))
unstacked_fan = as.data.frame(unstacked_fan)

unstacked_fan %>% select(2,3,6) -> unstacked_fan
colnames(unstacked_fan) = c("time", "AHU2E_status", "AHU2W_status")
unstacked_fan$time = as.POSIXlt(unstacked_fan$time)

# up fill dataset 
unstacked_fan %>% fill(AHU2E_status, .direction ="up") -> unstacked_fan
unstacked_fan %>% fill(AHU2W_status, .direction ="up") -> unstacked_fan


time_difference = function(time, times){
  if(!is.na(time)){
    differences = as.data.frame(times - time)
    colnames(differences) = c("value")
    pos_differences = dplyr::filter(differences, value > 0)$value
    pos_diff_index = which(as.numeric(pos_differences) == min(as.numeric(pos_differences)))
    rel_time = times[which(differences$value == pos_differences[pos_diff_index])]
    print(rel_time)
    
    unit_supply_air[unit_supply_air$time == rel_time,"AHU2W_fan_status"] <<- unstacked_fan[unstacked_fan$time==time, "AHU2W_status"]
    unit_supply_air[unit_supply_air$time == rel_time,"AHU2E_fan_status"] <<- unstacked_fan[unstacked_fan$time==time, "AHU2E_status"]
  }
  else{
    print("fail")
  }
}

times = unit_supply_air$time


for (i in 1:length(unstacked_fan$time)) {
  time = unstacked_fan$time[i]
  time_difference(time, times)
}

# at that found time, add the values of AHU2E status + AHU2W status
time = unstacked_fan$time[100]
differences = as.data.frame(times - time)
colnames(differences) = c("value")
pos_differences = filter(differences, value > 0)$value 
pos_diff_index = which(as.numeric(pos_differences) == min(as.numeric(pos_differences)))
rel_time = times[which(temp$value == pos_differences[pos_diff_index])]

unit_supply_air[unit_supply_air$time == rel_time,"AHU2W_fan_status"] = unstacked_fan[unstacked_fan$time==time, "AHU2W_status"]


unit_supply_air[unit_supply_air$time == rel_time,"AHU2E_fan_status"] = unstacked_fan[unstacked_fan$time==time, "AHU2E_status"]

```


## Table for analysis of system dynamics and room comfort

Key: room, Index: time
Observations: c02, occupied status, supply air flow, supply fan, temperature, supply air flow set-point



# Convert to tsibble objects
```{r}
co2 <- as_tsibble(co2, key= series, index = time)
occupied_status <- as_tsibble(occupied_status, key= series, index = time)
supply_air_flow <- as_tsibble(supply_air_flow, key= room, index = time)
supply_fan <- as_tsibble(supply_fan, key= series, index = time)
temperature <- as_tsibble(temperature, key= series, index = time)

```

