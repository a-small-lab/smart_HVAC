---
title: "Data Cleaning and (preliminary) EDA"
author: "Caleb Neale"
date: "Spring 2021"
output:
  html_notebook: default
  pdf_document: default
subtitle: Optimizing HVAC Operation for Occupant Comfort and Energy Savings
editor_options: 
  chunk_output_type: inline
---

# Load libraries 
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(fpp3)
```

# Import Data and convert to tibble
```{r warning=FALSE}
read_and_clean <- function(csv_path){
  df <- read.csv(csv_path, sep=";", row.names = NULL)
  colnames(df) <- c("series", 'time','value')
  
  # NAs will be induced by following line, seems like this occurs when the value in the 'value' column == null
  df$value <- as.numeric(df$value)
  df<- df[-1,]
  df <- as_tibble(df)
  return(df)
}

co2 <- read_and_clean('co2.csv')
occupied_status <- read_and_clean('occupied_status.csv')
occupied_status$value <- as.factor(occupied_status$value)
supply_air_flow <- read_and_clean('supply_air_flow.csv')
supply_fan <- read_and_clean('supply_fan.csv')
supply_fan$value <- as.factor(supply_fan$value)
temperature <- read_and_clean('temperature.csv')

```
# Check for NaN
```{r}
sum(is.na(occupied_status$value))
sum(is.na(co2$value))
sum(is.na(supply_air_flow$value)) # lot of NAs (over 32000)
sum(is.na(supply_fan$value))
sum(is.na(temperature$value)) # lot of NAs (over 15000)

```

# Convert time data to datetime format
```{r}

convert_to_datetime <- function(df){
  df$time <- gsub("-04:00$", "-0400", df$time)
  df$time <- gsub("-05:00$", "-0500", df$time)
  df$time <- strptime(df$time, format ="%Y-%m-%dT%H:%M:%S%z")
  df$time <- as.POSIXct(df$time)
  return(df)
}

co2 <- convert_to_datetime(co2)
occupied_status <- convert_to_datetime(occupied_status)
supply_air_flow <- convert_to_datetime(supply_air_flow)
supply_fan <- convert_to_datetime(supply_fan)
temperature <- convert_to_datetime(temperature)

```


# Investigate data in series columns
```{r}
co2 %>% count(series) 

supply_air_flow %>% count(value)

supply_fan %>% count(series)

temperature %>% count(series)

occupied_status %>% count(series)

```
Co2 data is only provided for 6 rooms: Olsson 203, 211, 213, 217, 221, 225. Investigating whether additional rooms are available. 
<!-- I'm guessing not: CO2 sensors are more expensive. -->

Supply_air_flow contains data for 45 rooms in Olsson hall, as well as set-point data for each room. (Note: Investigate documentation for definition of set-point data)

Temperature is given for 44 rooms in Olsson, all but the generic "2nd floor" label which was found in the supply_air_flow table. There is no set-point data provided here. 

Supply_fan_status is given for both HVAC units; the nature of the time intervals of the supply generating process is still under investigation. 

Occupied_status is given for both HVAC units. As the status is not given by room, I'm looking for documentation which shows what occupied_status means in the system. The nature of the time intervals of the supply generating process is still under investigation. 


# Create rooms column by parsing from series column 
```{r}
co2$room = regmatches(x= co2$series, m=regexpr("([0-9]{3})", co2$series))

supply_air_flow$room = str_match(supply_air_flow$series, "C[0-9]{3}|[0-9]{3}")

temperature$room = str_match(temperature$series, "C[0-9]{3}|[0-9]{3}")
```

There exists a mapping from HVAC unit to rooms 
<!-- Identify the data source for this mapping. -->
which could be used to relate observations on the room level and observations on the system level (e.g. which rooms are receiving supply at a given time based on supply_status data).


# Create room assignment vectors for each HVAC unit

```{r}
AHU_2E <- c(241, 243, 245, 247, 249, 251, 253, 257, 255, 259, 263, 261, 240, "C244", 244, 260, 213, 217, 225, 218, "C230", 220, "C210", "T212", "T218", "C216", "C214", "T210", 256, 229, 231, 223, 225, "C227", "C211", 254, "C250", 258) 

AHU_2W <- c(269, 267, 265, 273, 271, 275, 277, 279, 281, 283, 285, 274, 286, 204, 208, 272, 270, "C260", "C200", "C201", 203, 276, "C280", "C270", 211, 201)

rooms_tbl <- rbind(tibble('room' = AHU_2E, 'equipment' = "AHU_2E"), tibble('room' = AHU_2W, 'equipment' = "AHU_2W"))

# Check for duplicates/overlap
rooms_tbl %>% group_by(room) %>% count() %>% filter(n>1) -> dupes 

print(dupes)
```
A single room, `r dupes$room`, is served by both HVAC units.


# Parse equipment names from series column
```{r}
occupied_status$equiment <- str_match(occupied_status$series, "AHU2[EW]")
supply_fan$equipment     <- str_match(supply_fan$series, "AHU2[EW]")
```


# Table Designs

<!-- ## Table for analysis of system dynamics and energy consumption -->

## Table for room-specific indoor environmental quality data

Index: date-time, 3 hour intervals

Keys: room

Observations: 
 
 * CO$_2$ levels (ppm, mean)
 * temperature (degrees C)
 * supply air flow (ft^3 s-1), 
 * supply air flow set-point (ft^3 s-1), 

Data cleaning tasks:
- Unstack supply_air_flow data such that there is a column for value and a column for set-point for each room at each time-stamp
- Aggregate flow and set-point values for each HVAC unit to create an HVAC unit value at each time-stamp
- For every three hour interval, assign the supply fan status column to the most recent value from supply_fan for each AHU
- Calculate energy consumption and input into final column 

### Unstack supply_air_flow

```{r}
supply_air_flow %>% filter(grepl("Setpoint", series)) -> supply_air_flow_setpoints

supply_air_flow %>% filter(!grepl("Setpoint", series)) -> supply_air_flow
```

```{r check for duplicate records for room 225}
supply_air_flow %>% 
  filter(room == dupes$room) %>%
  group_by(time) %>%
  count() %>%
  filter(n>1)

supply_air_flow %>% 
  filter(room == dupes$room) %>%
  arrange(time)

supply_air_flow_setpoints %>% 
  filter(room == dupes$room) %>%
  group_by(time) %>%
  count() %>%
  filter(n>1)

supply_air_flow_setpoints %>% 
  filter(room == dupes$room) %>%
  arrange(time)
```

```{r join ieq data to unified table}
co2 %>%
  rename('co2_ppm_mean' = 'value') %>%
  select(time, room, co2_ppm_mean) -> co2_ts

temperature %>%
  rename('temperature_C' = 'value') %>%
  select(time, room, temperature_C) -> temperature_ts

supply_air_flow %>%
  rename('supply_air_flow_cfs' = 'value') %>%
  select(time, room, supply_air_flow_cfs) -> supply_air_flow_ts

supply_air_flow_setpoints %>%
  rename('supply_air_flow_setpoint_cfs' = 'value') %>%
  select(time, room, supply_air_flow_setpoint_cfs) -> supply_air_flow_setpoints_ts

full_join(co2_ts, temperature_ts, by=c("time", "room")) %>%
  full_join(supply_air_flow_ts, by=c("time", "room")) %>%
  full_join(supply_air_flow_setpoints_ts, by=c("time", "room")) -> ieq_tbl

print(ieq_tbl)
```
```{r check for duplicate entries}
ieq_tbl %>% filter(room == dupes$room) %>% arrange(time)
```

## Table of equipment operational data

Index: date-time, irregular time intervals

Keys: HVAC equipment code

Observations: 
 * supply fan (logical)
 * occupancy status (logical)
 
```{r}
supply_fan %>%
  rename('supply_fan_status' = 'value') %>%
  select(time, equipment, supply_fan_status) -> supply_fan_irreg_ts

occupied_status %>%
  rename('occupied' = 'value',
         'equipment' = 'equiment') %>%
  select(time, equipment, occupied) -> occupied_irreg_ts

equipment_ops_irreg_ts <- full_join(supply_fan_irreg_ts, occupied_irreg_ts, by=c("time", "equipment")) 

print(equipment_ops_irreg_ts %>% arrange(time))

```


Q: Do rooms that share HVAC equipment also share the same supply air flow and setpoints?

```{r do rooms that share HVAC equipment also share same supply air flow and setpoints}

ieq_tbl %>%
  filter(room %in% (rooms_tbl %>% filter(equipment == "AHU_2E") %>% pull(room))) %>%
  select(time, room, supply_air_flow_cfs, supply_air_flow_setpoint_cfs) %>%
  arrange(time, room)

```
A: Clearly not. Rooms can share the same HVAC equipment yet have different setpoints and different realized supply air flows.


```{r}
inner_join(supply_air_flow_setpoints,supply_air_flow, by=c("room", "time")) %>% select(c("time", "value.x", "value.y", "room")) -> unstacked_supply_air

colnames(unstacked_supply_air) <- c("time", "setpoint", "value", "room")

```

** Q: How does energy consumption related to reported values of system operations -- esp. supply air flow, supply fan status, occupied status? **

### Aggregate flow and set point by HVAC unit

<!-- Are you sure this aggregation operation is appropriate? How do these aggregated values relate to energy consumption? -->

```{r}
unstacked_supply_air <- as_tsibble(unstacked_supply_air, key= room, index = time)

unstacked_supply_air %>% filter(room %in% AHU_2E) -> air_supply_AHU_2E
unstacked_supply_air %>% filter(room %in% AHU_2W) -> air_supply_AHU_2W

aggregated_AHU_2E <- aggregate(cbind(air_supply_AHU_2E$setpoint, air_supply_AHU_2E$value), by=list(time=air_supply_AHU_2E$time), FUN=sum)

aggregated_AHU_2W <- aggregate(cbind(air_supply_AHU_2W$setpoint, air_supply_AHU_2W$value), by=list(time=air_supply_AHU_2W$time), FUN=sum)

colnames(aggregated_AHU_2E) = c("time", "setpoint", "air_supply")
colnames(aggregated_AHU_2W) = c("time", "setpoint", "air_supply")

inner_join(aggregated_AHU_2E, aggregated_AHU_2W, by=c("time"), suffix=c(".AHU2E", ".AHU2W")) -> unit_supply_air

```

### Feed forward supply_fan data
```{r, eval=FALSE}
# create df where columns are time, AHU2E status, AHU2W status
supply_fan %>% filter(equipment == "AHU2E") -> AHU2E_supply_fan
supply_fan %>% filter(equipment == "AHU2W") -> AHU2W_supply_fan

unstacked_fan = full_join(AHU2E_supply_fan, AHU2W_supply_fan, by=c("time"))
unstacked_fan = as.data.frame(unstacked_fan)

unstacked_fan %>% select(2,3,6) -> unstacked_fan
colnames(unstacked_fan) = c("time", "AHU2E_status", "AHU2W_status")
unstacked_fan$time = as.POSIXlt(unstacked_fan$time)

# up fill dataset 
unstacked_fan %>% fill(AHU2E_status, .direction ="up") -> unstacked_fan
unstacked_fan %>% fill(AHU2W_status, .direction ="up") -> unstacked_fan


# time_difference = function(time, times){
#   differences = as.data.frame(times - time)
#   colnames(differences) = c("value")
#   pos_differences = filter(temp, value > 0)$value 
#   pos_diff_index = which(as.numeric(pos_differences) == min(as.numeric(pos_differences)))
#   rel_time = times[which(temp$value == pos_differences[pos_diff_index])]
#   unit_supply_air[unit_supply_air$time == rel_time,"AHU2W_fan_status"] = unstacked_fan[unstacked_fan$time==time, "AHU2W_status"]
# 
#   unit_supply_air[unit_supply_air$time == rel_time,"AHU2E_fan_status"] = unstacked_fan[unstacked_fan$time==time, "AHU2E_status"]
# }

times = unit_supply_air$time

# for (time in unstacked_fan$time) {
#  time_difference(time, times)
# }

# at that found time, add the values of AHU2E status + AHU2W status

temp = as.data.frame(times - unstacked_fan$time[100])
colnames(temp) = c("value")
pos_differences = filter(temp, value > 0)$value 
pos_diff_index = which(as.numeric(pos_differences) == min(as.numeric(pos_differences)))
rel_time = times[which(temp$value == pos_differences[pos_diff_index])]

unit_supply_air[unit_supply_air$time == rel_time,"AHU2W_fan_status"] = unstacked_fan[unstacked_fan$time==unstacked_fan$time[100], "AHU2W_status"]

unit_supply_air[unit_supply_air$time == rel_time,"AHU2E_fan_status"] = unstacked_fan[unstacked_fan$time==time, "AHU2E_fan_status"]

```




## Table for analysis of system dynamics and room comfort

Key: room, Index: time

Observations: 

* c02, 
* occupied status, 
* supply air flow, 
* supply fan, 
* temperature, 
* supply air flow set-point



# Convert to tsibble objects
```{r}
co2 <- as_tsibble(co2, key= series, index = time)
occupied_status <- as_tsibble(occupied_status, key= series, index = time)
supply_air_flow <- as_tsibble(supply_air_flow, key= room, index = time)
supply_fan <- as_tsibble(supply_fan, key= series, index = time)
temperature <- as_tsibble(temperature, key= series, index = time)

```

